<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Onion Server Setup</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <section id="start">
    <img src="icons/spinner.svg" class="spin" alt="Loading...">
    <h1>Loading...</h1>
  </section>

  <section id="error" style="display: none;">
    <h1>Error</h1>
    <p>Failed to start the Onion Server Management Software. Please check the console for details.</p>
  </section>

  <section id="setup" style="display: none;">
    <form id="setup-form">
      <div class="input-wrapper">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
      </div>
      
      <div class="input-wrapper">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
      </div>
      
      <p>We've detected that it's the first time you run the software so please create a superuser account.</p>
      <button type="submit">Create User</button>
    </form>
  </section>

  <section id="login" style="display: none;">
    <form id="login-form">
      <div class="input-wrapper">
        <label for="login-username">Username</label>
        <input type="text" id="login-username" name="username" required>
      </div>
      <div class="input-wrapper">
        <label for="login-password">Password:</label>
        <input type="password" id="login-password" name="password" required>
      </div>
      
      <button type="submit">Login</button>
    </form>
  </section>

  <section id="dashboard" style="display: none;">
    <nav>
      <div>
        <img src="img/sodium.png" alt="Sodium Logo">
        <h1>Sodium Server Management</h1>
      </div>
    </nav>
    <section class="dash-grid-4">
      <div class="dash-item item-online">
        <div>
          <b>Online</b>
          <p>Website Status</p>
        </div>
        <div class="dash-item-bg">
          <div class="online"></div>
        </div>
      </div>
      <div class="dash-item">
        <div>
          <b>500</b>
          <p>Website Users</p>
        </div>
        <canvas id="usersChart" class="chart"></canvas>
      </div>
      <div class="dash-item">
        <div>
          <b>0</b>
          <p>Messages sent</p>
        </div>
      </div>
      <div class="dash-item">
        <div>
          <b>0</b>
          <p>Website Visitors</p>
        </div>
      </div>
    </section>
    <section class="dash-grid-2">
      <div class="dash-item">
        <div>
          <b>0</b>
          <p>MB/out</p>
        </div>
      </div>
      <div class="dash-item">
        <div>
          <b>0</b>
          <p>MB/in</p>
        </div>
      </div>
    </section>
  </section>

  <script>
    function show(id) {
      document.getElementById(id).style.display = 'flex';
    }
    function hide(id) {
      document.getElementById(id).style.display = 'none';
    }

    async function waitForAPI(retries = 20, delay = 500) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch('http://127.0.0.1:8081/startup');
          if (res.ok) return await res.json();
        } catch (err) {
          // API not ready yet
        }
        await new Promise(resolve => setTimeout(resolve, delay));
      }
      throw new Error("FastAPI backend did not start.");
    }

    async function waitForWebsite(retries = 20, delay = 500) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch('http://127.0.0.1:8080/');
          if (res.ok) return await res.json();
        } catch (err) {
          // API not ready yet
        }
        await new Promise(resolve => setTimeout(resolve, delay));
      }
      throw new Error("Website is not running.");
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await window.electronAPI.runPython('management/app.py');
        if (response != "Started") throw new Error("Failed to execute Python script.");
        console.log('Python script executed:', response);
        const data = await waitForAPI();
        hide('start');
        data.hasUser ? show('dashboard') : show('setup');
      } catch (error) {
        hide('start');
        show('error');
        console.error('Error starting management software:', error);
      }
    });

    document.getElementById('setup-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      try {
        const response = await fetch('http://127.0.0.1:8081/setup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: formData.get('username'),
            password: formData.get('password')
          })
        });
        if (response.ok) {
          hide('setup');
          show('login');
        } else {
          throw new Error('Failed to create user');
        }
      } catch (error) {
        console.error('Error during setup:', error);
      }
    });

    async function loadDashboard() {
      try {
        let status = false;
        const response = await waitForWebsite();
        if (response != "Started") 
        console.log('Website loaded:', response);
        show('dashboard');
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

     document.getElementById('login-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      try {
        const response = await fetch('http://127.0.0.1:8081/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: formData.get('username'),
            password: formData.get('password')
          })
        });
        if (response.ok) {
          hide('login');
          loadDashboard();
        } else {
          throw new Error('Failed to login');
        }
      } catch (error) {
        console.error('Error during login:', error);
      }
    });

    async function runWebsite() {
      try {
        const response = await window.electronAPI.runWebsite('website/app.py');
        if (response != "Started") throw new Error("Failed to execute website script.");
        console.log('Website script executed:', response);
      } catch (error) {
        console.error('Error starting website:', error);
      }
    };
  </script>

  <script>
    const userChart = document.getElementById('usersChart').getContext('2d');
    const usersCart = new Chart(userChart, {
      type: 'line',
      data: {
        labels: ['5 days ago', '4 days ago', '3 days ago', '2 days ago', 'yesterday', 'today'],
        datasets: [{
          data: [0, 12, 90, 32, 87, 298],
          borderColor: 'rgb(122, 174, 204, 1)',
          backgroundColor: 'rgb(122, 174, 204, 0.2)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 0
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false  // <-- disables the tooltip
          }
        },
        interaction: {
          intersect: false,
        },
        scales: {
          x: {
            display: false,
            title: {
              display: false
            }
          },
          y: {
            display: false,
            beginAtZero: false,
            title: {
              display: false
            },
            suggestedMin: 10,
            suggestedMax: 50
          }
        }
      }
    });
  </script>
</body>
</html>
